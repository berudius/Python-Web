<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Мої бронювання - Edemium</title>
    <style>
        :root { --accent: #2b7a78; --muted: #6b7280; --bg: #f7fafc; --card: #ffffff; --danger: #d9534f; --success: #4caf50; --warning: #f0ad4e; --info-bg: #e7f3fe; --info-text: #31708f; --success-bg: #d4edda; --success-text: #155724; }
        * { box-sizing: border-box; }
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; background: var(--bg); color: #111; }
        header { position: fixed; top: 0; left: 0; width: 100%; padding: 18px 24px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10; }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 16px; }
        .nav { display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 12px; color: #111; }
        .logo { width: 44px; height: 44px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        nav ul { display: flex; gap: 18px; list-style: none; margin: 0; padding: 0; }
        nav li { font-size: 15px; color: var(--muted); font-weight: 500; }
        nav li a:hover { color: var(--accent); text-decoration: none; }
        .actions { display: flex; align-items: center; gap: 10px; }
        .cta { background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: inline-block; text-align: center;}
        .cta:hover { background: #22605e; text-decoration: none; }
        .cta-outline { border: 2px solid var(--accent); color: var(--accent); padding: 8px 14px; border-radius: 10px; font-weight: 600; background: transparent; transition: 0.2s ease; display: inline-block; text-align: center;}
        .cta-outline:hover { background: var(--accent); color: white; text-decoration: none; }
        main { padding-top: 120px; padding-bottom: 34px; }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .message-card { padding: 15px; border-radius: 8px; }
        .message-card.success { background-color: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-text); }
        .message-card.error { background-color: #fddede; color: var(--danger); border: 1px solid var(--danger); }
        .message-card.info { background-color: var(--info-bg); color: var(--info-text); border: 1px solid var(--info-text); }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f8fafc; font-weight: 600; }
        .status { padding: 4px 8px; border-radius: 99px; font-weight: 500; font-size: 12px; }
        .status.confirmed { background-color: var(--success-bg); color: var(--success-text); }
        .status.pending { background-color: #fffbeb; color: #b45309; }
        .status.cancelled { background-color: #fee2e2; color: #b91c1c; }
        .status.completed { background-color: #f0fdf4; color: #15803d; }
        .btn { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 500; text-align: center; display: inline-block; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .admin-controls form { display: flex; gap: 16px; align-items: center; margin-bottom: 24px; }
    </style>
</head>
<body>
    <header>
         <div class="container nav">
            <a href="/" class="brand">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="logo">E</div>
                    <div>
                        <div style="font-weight:700">Edemium</div>
                        <div style="font-size:12px; color:var(--muted)">Цифровий сервіс готельної мережі</div>
                    </div>
                </div>
            </a>
            <nav aria-label="Головне меню">
                <ul>
                    <li><a href="/rooms">Номери</a></li>
                    <li><a href="/services">Сервіси</a></li>
                    <li><a href="/about_us">Про нас</a></li>
                    <li><a href="/my-bookings">Мої бронювання</a></li>
                    {% if is_admin %}
                    <li><a href="/my-bookings">Панель бронювань</a></li>
                    {% endif %}
                </ul>
            </nav>
            <div class="actions">
                {% if not is_authorized %}
                <a class="cta-outline" href="{{ login_url }}">Увійти</a>
                <a class="cta" href="{{ register_url }}">Зареєструватися</a>
                {% else %}
                <a class="cta-outline" href="{{ USER_SERVICE_URL }}/logout">Вийти</a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="container">
        <h1>{% if is_admin %}Панель керування бронюваннями{% else %}Мої бронювання{% endif %}</h1>

        {% if success_message %}<div class="card message-card success"><p>{{ success_message }}</p></div>{% endif %}
        {% if booking_error %}<div class="card message-card error"><p>{{ booking_error }}</p></div>{% endif %}

        {% if is_admin %}
        <div class="card admin-controls">
            <form method="get" action="/my-bookings">
                <select name="status_filter" onchange="this.form.submit()">
                    <option value="">Всі статуси</option>
                    <option value="Розглядається" {% if status_filter == 'Розглядається' %}selected{% endif %}>Розглядається</option>
                    <option value="Підтверджено" {% if status_filter == 'Підтверджено' %}selected{% endif %}>Підтверджено</option>
                    <option value="Скасовано" {% if status_filter == 'Скасовано' %}selected{% endif %}>Скасовано</option>
                    <option value="Завершено" {% if status_filter == 'Завершено' %}selected{% endif %}>Завершено</option>
                </select>
                <input type="text" name="phone_filter" placeholder="Пошук за номером..." value="{{ phone_filter or '' }}">
                <button type="submit" class="cta">Фільтрувати</button>
                <a href="/my-bookings" class="cta-outline">Скинути</a>
            </form>
        </div>
        {% endif %}

        {% if is_authorized %}
            {% if not is_admin and trust_level > 0 %}
            <div class="card message-card info"><p><strong>Ваш поточний рівень довіри: {{ trust_level }}.</strong></p></div>
            {% endif %}

            {% if my_bookings %}
                <div class="card table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Дати</th>
                                <th>Номери</th>
                                {% if is_admin %}<th>Користувач</th><th>Телефон</th>{% endif %}
                                <th>Статус</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in my_bookings %}
                            <tr id="booking-row-{{ booking.id }}">
                                <td>#{{ booking.id }}</td>
                                <td>{{ booking.arrival_date.strftime('%d.%m') }} - {{ booking.departure_date.strftime('%d.%m.%Y') }}</td>
                                <td>
                                    <ul style="margin:0; padding-left: 15px;">
                                    {% for room in booking.rooms %}<li>{{ room.type }}</li>{% endfor %}
                                    </ul>
                                </td>
                                {% if is_admin %}<td>{{ booking.user_id or 'Гість' }}</td><td>{{ booking.phone_number }}</td>{% endif %}
                                <td><span class="status" id="status-{{ booking.id }}">{{ booking.status }}</span></td>
                                <td id="actions-{{ booking.id }}">
                                    {% if is_admin and booking.status == 'Розглядається' %}
                                        <button class="btn btn-success" onclick="updateStatus({{ booking.id }}, 'Підтверджено')">Підтвердити</button>
                                        <button class="btn btn-danger" onclick="updateStatus({{ booking.id }}, 'Скасовано')">Відхилити</button>
                                    {% elif not is_admin and booking.status in ['Розглядається', 'Підтверджено'] and trust_level > 0 %}
                                        <form method="post" action="/bookings/cancel/{{ booking.id }}" onsubmit="return handleCancel(event);"><button type="submit" class="btn-danger">Скасувати</button></form>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="card"><p>Не знайдено бронювань за вашими критеріями.</p></div>
            {% endif %}
        {% else %}
            <div class="card auth-cta-card">
                <h2>Керуйте своїми бронюваннями</h2>
                <p>Увійдіть до свого акаунту або зареєструйтесь, щоб переглядати історію, статуси та керувати своїми бронюваннями в одному місці.</p>
                <div class="actions"><a class="cta-outline" href="{{ login_url }}">Увійти</a><a class="cta" href="{{ register_url }}">Створити акаунт</a></div>
            </div>
        {% endif %}
    </main>

    <script>
        function handleCancel(event) {
            event.preventDefault();
            const userTrustLevel = {{ trust_level | default(0) }};
            let warningMessage = "Ви впевнені, що хочете скасувати це бронювання?";
            if (userTrustLevel === 1) {
                warningMessage += "\n\nУВАГА: Це призведе до зниження вашого рівня довіри до 0, і ви не зможете скасовувати бронювання онлайн у майбутньому.";
            } else if (userTrustLevel === 2 || userTrustLevel === 3) {
                warningMessage += "\n\nПОПЕРЕДЖЕННЯ: Часті скасування можуть призвести до зниження вашого рівня довіри.";
            }
            if (confirm(warningMessage)) {
                event.target.submit();
            }
        }

        {% if is_admin %}
        async function updateStatus(bookingId, newStatus) {
            try {
                const response = await fetch(`/admin/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                if (response.ok) {
                    const statusEl = document.getElementById(`status-${bookingId}`);
                    const actionsEl = document.getElementById(`actions-${bookingId}`);
                    statusEl.textContent = newStatus;
                    actionsEl.innerHTML = 'Оновлено';
                    alert(result.message || 'Статус успішно оновлено!');
                } else {
                    throw new Error(result.detail || 'Не вдалося оновити статус.');
                }
            } catch (error) {
                console.error('Помилка:', error);
                alert(`Помилка: ${error.message}`);
            }
        }
        {% endif %}
    </script>
</body>
</html>