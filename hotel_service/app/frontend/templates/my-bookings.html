<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Мої бронювання - Edemium</title>
    <style>
        :root { --accent: #2b7a78; --muted: #6b7280; --bg: #f7fafc; --card: #ffffff; --danger: #d9534f; --info-bg: #e7f3fe; --info-text: #31708f; --success-bg: #d4edda; --success-text: #155724; }
        * { box-sizing: border-box; }
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; background: var(--bg); color: #111; }
        header { position: fixed; top: 0; left: 0; width: 100%; padding: 18px 24px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10; }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }
        .nav { display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 12px; color: #111; }
        .logo { width: 44px; height: 44px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        nav ul { display: flex; gap: 18px; list-style: none; margin: 0; padding: 0; }
        nav li { font-size: 15px; color: var(--muted); font-weight: 500; }
        nav li a:hover { color: var(--accent); text-decoration: none; }
        .actions { display: flex; align-items: center; gap: 10px; }
        .cta { background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: inline-block; text-align: center;}
        .cta:hover { background: #22605e; text-decoration: none; }
        .cta-outline { border: 2px solid var(--accent); color: var(--accent); padding: 8px 14px; border-radius: 10px; font-weight: 600; background: transparent; transition: 0.2s ease; display: inline-block; text-align: center;}
        .cta-outline:hover { background: var(--accent); color: white; text-decoration: none; }
        main { padding-top: 120px; padding-bottom: 34px; }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .message-card { padding: 15px; border-radius: 8px; }
        .message-card.success { background-color: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-text); }
        .message-card.error { background-color: #fddede; color: var(--danger); border: 1px solid var(--danger); }
        .message-card.info { background-color: var(--info-bg); color: var(--info-text); border: 1px solid var(--info-text); }
        .booking-card { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start; }
        .booking-card h4 { margin-top: 0; }
        .booking-card p { margin-bottom: 8px; }
        .booking-room-list { padding-left: 20px; margin: 0; }
        .actions-column { display: flex; flex-direction: column; gap: 10px; }
        .btn-danger { background-color: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 500; text-align: center; }
        .btn-danger:hover { background-color: #c9302c; text-decoration: none; }
        .auth-cta-card { text-align: center; padding: 48px 24px; }
        .auth-cta-card h2 { margin-top: 0; font-size: 1.75rem; }
        .auth-cta-card p { color: var(--muted); margin-bottom: 24px; }
        .auth-cta-card .actions { justify-content: center; }
    </style>
</head>
<body>
    <header>
        <div class="container nav">
            <a href="/" class="brand">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="logo">E</div>
                    <div>
                        <div style="font-weight:700">Edemium</div>
                        <div style="font-size:12px; color:var(--muted)">Цифровий сервіс готельної мережі</div>
                    </div>
                </div>
            </a>
            <nav aria-label="Головне меню">
                <ul>
                    <li><a href="/rooms">Номери</a></li>
                    <li><a href="/services">Сервіси</a></li>
                    <li><a href="/about_us">Про нас</a></li>
                    <li><a href="/my-bookings">Мої бронювання</a></li>
                </ul>
            </nav>
            <div class="actions">
                {% if not is_authorized %}
                <a class="cta-outline" href="{{ login_url }}">Увійти</a>
                <a class="cta" href="{{ register_url }}">Зареєструватися</a>
                {% else %}
                <a class="cta-outline" href="{{ USER_SERVICE_URL }}/logout">Вийти</a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="container">
        <h1>Мої бронювання</h1>

        {% if success_message %}
        <div class="card message-card success">
            <p>{{ success_message }}</p>
        </div>
        {% endif %}

        {% if booking_error %}
        <div class="card message-card error">
            <p>{{ booking_error }}</p>
        </div>
        {% endif %}

        {% if is_authorized %}
            {% if trust_level > 0 %}
            <div class="card message-card info">
                <p><strong>Ваш поточний рівень довіри: {{ trust_level }}.</strong> Скасування бронювань може вплинути на ваш рівень.</p>
            </div>
            {% endif %}

            {% if my_bookings %}
                <section class="bookings-list">
                    {% for booking in my_bookings %}
                    <div class="card booking-card">
                        <div class="booking-card-content">
                            <h4>Бронювання #{{ booking.id }} (Статус: <strong>{{ booking.status }}</strong>)</h4>
                            <p><strong>Дати:</strong> {{ booking.arrival_date.strftime('%d.%m.%Y') }} - {{ booking.departure_date.strftime('%d.%m.%Y') }}</p>
                            <p><strong>Контактний номер:</strong> {{ booking.phone_number }}</p>
                            <p><strong>Номери:</strong></p>
                            <ul class="booking-room-list">
                                {% for room in booking.rooms %}
                                <li>{{ room.type }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="actions-column">
                             {% if booking.status in ['Розглядається', 'Підтверджено'] and trust_level > 0 %}
                            <form method="post" action="/bookings/cancel/{{ booking.id }}" onsubmit="return handleCancel(event);">
                                <button type="submit" class="btn-danger">Скасувати</button>
                            </form>
                             {% elif booking.status in ['Розглядається', 'Підтверджено'] and trust_level == 0 %}
                                <p style="color: var(--muted); font-size: 14px; text-align: center;">Для скасування зв'яжіться з адміністрацією.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </section>
            {% else %}
                <div class="card">
                    <p>У вас ще немає активних бронювань. <a href="/rooms">Бажаєте забронювати номер?</a></p>
                </div>
            {% endif %}
        {% else %}
            <div class="card auth-cta-card">
                <h2>Керуйте своїми бронюваннями</h2>
                <p>Увійдіть до свого акаунту або зареєструйтесь, щоб переглядати історію, статуси та керувати своїми бронюваннями в одному місці.</p>
                <div class="actions">
                    <a class="cta-outline" href="{{ login_url }}" style="min-width: 150px;">Увійти</a>
                    <a class="cta" href="{{ register_url }}" style="min-width: 150px;">Створити акаунт</a>
                </div>
            </div>
        {% endif %}

    </main>

    {% if is_authorized %}
    <script>
        const userTrustLevel = {{ trust_level }};

        function handleCancel(event) {
            // Запобігаємо стандартній відправці форми, щоб показати кастомне попередження
            event.preventDefault(); 

            let warningMessage = "Ви впевнені, що хочете скасувати це бронювання?";

            if (userTrustLevel === 1) {
                warningMessage += "\n\nУВАГА: Це призведе до зниження вашого рівня довіри до 0, і ви не зможете скасовувати бронювання онлайн у майбутньому.";
            } else if (userTrustLevel === 2) {
                warningMessage += "\n\nПОПЕРЕДЖЕННЯ: Якщо це друге скасування поспіль, ваш рівень довіри буде знижено до 1.";
            } else if (userTrustLevel === 3) {
                 warningMessage += "\n\nПОПЕРЕДЖЕННЯ: Якщо це третє скасування поспіль, ваш рівень довіри буде знижено до 1.";
            }

            if (confirm(warningMessage)) {
                // Якщо користувач натиснув "OK", відправляємо форму програмно
                event.target.submit();
            } else {
                // Якщо користувач натиснув "Cancel", нічого не відбувається
                return false;
            }
        }
    </script>
    {% endif %}

</body>
</html>