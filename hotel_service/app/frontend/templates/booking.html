<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Підтвердження бронювання - Edemium</title>
    <style>
        :root { --accent: #2b7a78; --muted: #6b7280; --bg: #f7fafc; --card: #ffffff; }
        * { box-sizing: border-box; }
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; background: var(--bg); color: #111; }
        header { position: fixed; top: 0; left: 0; width: 100%; padding: 18px 24px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10; }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }
        .nav { display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 12px; color: #111; }
        .logo { width: 44px; height: 44px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        nav ul { display: flex; gap: 18px; list-style: none; margin: 0; padding: 0; }
        nav li { font-size: 15px; color: var(--muted); font-weight: 500; }
        nav li a:hover { color: var(--accent); text-decoration: none; }
        .actions { display: flex; align-items: center; gap: 10px; }
        .cta { background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: inline-block; text-align: center;}
        .cta:hover { background: #22605e; text-decoration: none; }
        .cta-outline { border: 2px solid var(--accent); color: var(--accent); padding: 8px 14px; border-radius: 10px; font-weight: 600; background: transparent; transition: 0.2s ease; display: inline-block; text-align: center;}
        .cta-outline:hover { background: var(--accent); color: white; text-decoration: none; }
        main { padding-top: 120px; padding-bottom: 34px; }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <header>
        <div class="container nav">
             <a href="/" class="brand">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="logo">E</div>
                    <div>
                        <div style="font-weight:700">Edemium</div>
                        <div style="font-size:12px; color:var(--muted)">Цифровий сервіс готельної мережі</div>
                    </div>
                </div>
            </a>
            <nav aria-label="Головне меню">
                <ul>
                    <li><a href="/rooms">Номери</a></li>
                    <li><a href="/services">Сервіси</a></li>
                    <li><a href="/about_us">Про нас</a></li>
                    <li><a href="/my-bookings">Мої бронювання</a></li>
                </ul>
            </nav>
            <div class="actions">
                {% if not is_authorized %}
                <a class="cta-outline" href="{{ login_url }}">Увійти</a>
                <a class="cta" href="{{ register_url }}">Зареєструватися</a>
                {% else %}
                <a class="cta-outline" href="{{ USER_SERVICE_URL }}/logout">Вийти</a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="container">
        <h1>Підтвердження бронювання</h1>
        <div class="card">
            <h2>Ваші дані для бронювання</h2>
            
            {% if is_authorized and trust_level >= 2 %}
            <div id="trusted-booking-section">
                <p><strong>Ваш рівень довіри: {{ trust_level }}.</strong></p>
                <p>Ми цінуємо вашу лояльність! Ви можете забронювати номер без додаткового підтвердження. Натисніть кнопку нижче, і ми оформимо ваше замовлення.</p>
                <form id="trusted-booking-form">
                     <input type="hidden" name="book_without_confirmation" value="true">
                    <button type="submit" class="cta">Забронювати без підтвердження</button>
                </form>
            </div>
            {% else %}
            <div id="standard-booking-section">
                 <p>Будь ласка, вкажіть контактний номер телефону. Наш адміністратор зв'яжеться з вами для підтвердження бронювання.</p>
                <form id="booking-form">
                    <div class="form-group">
                        <label for="phone_number">Номер телефону</label>
                        <input type="tel" id="phone_number" name="phone_number" value="{{ phone_number }}" required>
                    </div>
                     {% if is_authorized %}
                        <div class="checkbox-group">
                            <input type="checkbox" id="save_phone" name="save_phone">
                            <label for="save_phone">Зберегти цей номер в моєму профілі</label>
                        </div>
                    {% endif %}
                    <button type="submit" class="cta">Забронювати</button>
                </form>
            </div>
             {% endif %}
        </div>
        
        {% if not is_authorized %}
        <div class="card">
            <h3>Маєте акаунт?</h3>
            <p>Увійдіть, щоб бронювати швидше та керувати своїми замовленнями. <a href="{{ login_url }}">Увійти</a></p>
            <p>Немає акаунту? <a href="{{ register_url }}">Зареєструйтесь</a>, щоб отримати доступ до історії бронювань та програми лояльності.</p>
        </div>
        {% endif %}
    </main>

    <script>
        // This script will handle the form submission via fetch API
        // to provide a smoother user experience without a full page reload.

        document.getElementById('trusted-booking-form')?.addEventListener('submit', handleFormSubmit);
        document.getElementById('booking-form')?.addEventListener('submit', handleFormSubmit);

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const isTrustedForm = form.id === 'trusted-booking-form';

            const payload = {
                room_ids: JSON.parse(localStorage.getItem('selected_rooms') || '[]'),
                arrival_date: localStorage.getItem('arrival_date'),
                departure_date: localStorage.getItem('departure_date'),
                phone_number: isTrustedForm ? '{{ phone_number }}' : formData.get('phone_number'),
                save_phone: !isTrustedForm && formData.get('save_phone') === 'on',
                book_without_confirmation: isTrustedForm
            };

            try {
                const response = await fetch('/bookings/create_json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();

                if (result.success) {
                    // Clear local storage
                    localStorage.removeItem('selected_rooms');
                    localStorage.removeItem('arrival_date');
                    localStorage.removeItem('departure_date');
                    
                    // Redirect to my-bookings page
                    window.location.href = '/my-bookings';
                } else {
                    alert('Не вдалося створити бронювання: ' + result.message);
                }
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
                alert('Сталася помилка. Будь ласка, спробуйте ще раз.');
            }
        }
    </script>
</body>
</html>