<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Номери та ціни - Edemium</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.css">
    <style>
        :root { --accent: #2b7a78; --muted: #6b7280; --bg: #f7fafc; --card: #ffffff; --border: #e2e8f0; }
        * { box-sizing: border-box; }
        body { font-family: Inter, system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: #111; }
        header { position: fixed; top: 0; left: 0; width: 100%; padding: 18px 24px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 1000; }
        a { color: var(--accent); text-decoration: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .nav { display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 12px; color: #111; }
        .logo { width: 44px; height: 44px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        nav ul { display: flex; gap: 18px; list-style: none; margin: 0; padding: 0; }
        .actions { display: flex; align-items: center; gap: 10px; }
        .cta { background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: inline-block; }
        .cta:hover { background: #22605e; }
        .cta-outline { border: 2px solid var(--accent); color: var(--accent); padding: 8px 14px; border-radius: 10px; font-weight: 600; background: transparent; }

        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 32px; padding-top: 100px; }
        #filters-aside { position: sticky; top: 100px; align-self: start; }
        #filters-form { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; }
        .filter-group { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .filter-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .filter-group h4 { margin-top: 0; }
        #price-slider { margin: 20px 0; }
        .price-inputs { display: flex; gap: 10px; align-items: center; }
        .price-inputs input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
        .facilities-list { display: flex; flex-direction: column; gap: 10px; }
        .facilities-list label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

        #room-list-container { transition: opacity 0.3s ease; }
        .room-card { display: grid; grid-template-columns: 300px 1fr; gap: 24px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 24px; overflow: hidden; }
        .room-images { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }
        .room-images img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .room-info { padding: 24px; display: flex; flex-direction: column; }
        .room-info h3 { margin: 0 0 8px; }
        .price { font-size: 1.2rem; font-weight: 600; color: var(--accent); }
        .facilities { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
        .facilities span { background: #eef7f7; color: var(--accent); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .room-actions { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <header>
        <div class="container nav">
            <a href="/" class="brand">...</a>
            <nav>...</nav>
            <div class="actions">...</div>
        </div>
    </header>

    <div class="container layout">
        <aside id="filters-aside">
            <form id="filters-form">
                <div class="filter-group">
                    <h4>Ціна за ніч (грн)</h4>
                    <div id="price-slider"></div>
                    <div class="price-inputs">
                        <input type="number" id="min-price" name="min_price">
                        <span>-</span>
                        <input type="number" id="max-price" name="max_price">
                    </div>
                </div>
                <div class="filter-group">
                    <h4>Кількість гостей</h4>
                    <input type="number" id="min-guests" name="min_guests" min="1" style="width:100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                </div>
                <div class="filter-group">
                    <h4>Зручності</h4>
                    <div class="facilities-list">
                        {% for facility in all_facilities %}
                        <label>
                            <input type="checkbox" name="facilities" value="{{ facility }}" {% if facility in selected_facilities %}checked{% endif %}>
                            {{ facility }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                 <button type="button" onclick="resetFilters()" class="cta-outline" style="width: 100%;">Скинути всі фільтри</button>
            </form>
        </aside>

        <main id="room-list-container">
            {% include '_room_list_partial.html' %}
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.js"></script>
    <script>
        let debounceTimer;

        function updateRooms() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const form = document.getElementById('filters-form');
                const container = document.getElementById('room-list-container');
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                params.append('partial', 'true');
                
                const url = `/rooms?${params.toString()}`;
                
                container.style.opacity = 0.5;

                try {
                    const response = await fetch(url);
                    const html = await response.text();
                    container.innerHTML = html;
                    history.pushState({}, '', `/rooms?${params.toString().replace('&partial=true','')}`);
                } catch (error) {
                    console.error("Помилка при оновленні номерів:", error);
                } finally {
                    container.style.opacity = 1;
                }
            }, 500);
        }

        function resetFilters() {
             window.location.href = '/rooms';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('filters-form');
            form.addEventListener('change', updateRooms);
            form.addEventListener('input', (e) => {
                // Для текстових полів, щоб реагувало одразу
                if (e.target.type === 'number') {
                    updateRooms();
                }
            });

            const priceSlider = document.getElementById('price-slider');
            const minPriceInput = document.getElementById('min-price');
            const maxPriceInput = document.getElementById('max-price');

            noUiSlider.create(priceSlider, {
                start: [{{ min_price or 0 }}, {{ max_price or 5000 }}],
                connect: true,
                range: { 'min': 0, 'max': 10000 },
                step: 100,
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                }
            });

            priceSlider.noUiSlider.on('update', (values, handle) => {
                const [min, max] = values;
                if (handle === 0) {
                    minPriceInput.value = min;
                } else {
                    maxPriceInput.value = max;
                }
            });
            
            priceSlider.noUiSlider.on('end', updateRooms); // Оновлювати тільки коли користувач відпустив повзунок

            minPriceInput.addEventListener('change', () => priceSlider.noUiSlider.set([minPriceInput.value, null]));
            maxPriceInput.addEventListener('change', () => priceSlider.noUiSlider.set([null, maxPriceInput.value]));
        });
    </script>
</body>
</html>