# Повна технічна документація системи "Edemium"

Цей документ детально описує всі маршрути (routes) та пов'язану з ними логіку фронтенду для кожного мікросервісу системи.

---

## **Частина I: User Service (Сервіс Користувачів)**

Відповідає за реєстрацію, автентифікацію та керування даними користувачів.

### **Розділ 1.1: Автентифікація (`auth_router.py`)**

*   **GET `/registration`**:
    *   **Роут:** `auth_router.py`, функція `get_registration_page`.
    *   **Логіка:** Рендерить сторінку реєстрації. Приймає `redirect_url` для повернення користувача після успішної дії.
    *   **Фронтенд (`registration.html`):** Форма для введення email, пароля та імені.

*   **POST `/registration`**:
    *   **Роут:** `auth_router.py`, функція `register_user`.
    *   **Логіка:** Створює нового користувача в базі даних з роллю `user` та рівнем довіри `0`. Автоматично автентифікує користувача і перенаправляє на `redirect_url`.

*   **GET `/login`**:
    *   **Роут:** `auth_router.py`, функція `get_login_page`.
    *   **Логіка:** Рендерить сторінку входу. Приймає `redirect_url` та `guest_bookings` для подальшої синхронізації.
    *   **Фронтенд (`login.html`):** Форма для введення email та пароля.

*   **POST `/login`**:
    *   **Роут:** `auth_router.py`, функція `login_user`.
    *   **Логіка:** Перевіряє дані користувача. Якщо вони вірні, встановлює дані сесії (`user_id`, `user_role`) і перенаправляє.

*   **GET `/logout`**:
    *   **Роут:** `auth_router.py`, функція `logout`.
    *   **Логіка:** Очищує сесію користувача і перенаправляє на головну сторінку.

### **Розділ 1.2: API Користувачів (`users_router.py`)**

Ці роути є внутрішніми API і не мають прямого фронтенду. Вони викликаються іншими сервісами (наприклад, `hotel_service`).

*   **GET `/users/{user_id}`**:
    *   **Роут:** `users_router.py`, функція `get_user_by_id`.
    *   **Логіка:** Надає дані користувача (включно з `trust_level`, `consecutive_cancellations`) за його ID.

*   **PATCH `/users/{user_id}`**:
    *   **Роут:** `users_router.py`, функція `update_user_partially`.
    *   **Логіка:** Дозволяє частково оновлювати дані користувача (наприклад, змінити `trust_level` або номер телефону).

---

## **Частина II: Hotel Service (Готельний Сервіс)**

Відповідає за відображення номерів, бронювання та адміністрування.

### **Розділ 2.1: Публічні сторінки (`public_router.py`)**

*   **GET `/`**:
    *   **Роут:** `public_router.py`, функція `get_public_page`.
    *   **Логіка:** Рендерить головну сторінку.
    *   **Фронтенд (`public.html`):** Інформаційна сторінка з посиланням на каталог номерів.

*   **GET `/services`**:
    *   **Роут:** `public_router.py`, функція `get_services_page`.
    *   **Логіка:** Рендерить сторінку з описом послуг.
    *   **Фронтенд (`services.html`):** Статична інформаційна сторінка.

*   **GET `/about_us`**:
    *   **Роут:** `public_router.py`, функція `get_about_us_page`.
    *   **Логіка:** Рендерить сторінку "Про нас".
    *   **Фронтенд (`about_us.html`):** Статична інформаційна сторінка.


### **Розділ 2.2: Каталог та керування номерами (`rooms_router.py`)**

*   **GET `/rooms`**:
    *   **Роут:** `rooms_router.py`, функція `get_rooms`.
    *   **Логіка:** Рендерить каталог номерів з урахуванням фільтрів. Приймає прапор `partial` для динамічних оновлень.
    *   **Фронтенд (`rooms.html`):** Має бічну панель фільтрів (ціна, гості, зручності). JS за допомогою `fetch` запитує часткові оновлення (`partial=true`) і динамічно оновлює список номерів без перезавантаження сторінки.

*   **POST `/rooms`**:
    *   **Роут:** `rooms_router.py`, функція `create_room`.
    *   **Логіка (тільки для адмінів):** Приймає дані з форми, створює новий тип номеру та пов'язані з ним фізичні номери. Зберігає завантажені зображення.

*   **POST `/rooms/edit/{room_id}`**:
    *   **Роут:** `rooms_router.py`, функція `edit_room`.
    *   **Логіка (тільки для адмінів):** Оновлює інформацію про існуючий тип номеру.

*   **POST `/rooms/delete/{room_id}`**:
    *   **Роут:** `rooms_router.py`, функція `delete_room`.
    *   **Логіка (тільки для адмінів):** Видаляє тип номеру, пов'язані з ним записи та всі зображення з диска.

### **Розділ 2.3: Бронювання та адміністрування (`booking_router.py`)**

*   **GET `/bookings`**:
    *   **Роут:** `booking_router.py`, функція `get_booking_confirmation_page`.
    *   **Логіка:** Рендерить сторінку підтвердження бронювання з деталями обраних номерів та дат.
    *   **Фронтенд (`booking.html`):** Відображає фінальні деталі та форму для введення телефону.

*   **POST `/bookings/create_json`**:
    *   **Роут:** `booking_router.py`, функція `create_booking_json`.
    *   **Логіка:** Приймає JSON-запит від JS. Перевіряє рівень довіри користувача для можливого авто-підтвердження. Створює бронювання в БД.

*   **GET `/my-bookings`**:
    *   **Роут:** `booking_router.py`, функція `get_my_bookings_page`.
    *   **Логіка:** Рендерить сторінку "Мої бронювання", яка є також адмін-панеллю. Для адмінів показує всі бронювання та фільтри, для користувачів — лише їхні.
    *   **Фронтенд (`my-bookings.html`):** Використовує Jinja-умови (`{% if is_admin %}`) для відображення різного контенту та функціоналу залежно від ролі.

*   **POST `/bookings/cancel/{booking_id}`**:
    *   **Роут:** `booking_router.py`, функція `cancel_booking`.
    *   **Логіка (тільки для користувачів):** Дозволяє користувачеві скасувати власне бронювання. При цьому може бути знижено рівень довіри.
    *   **Фронтенд (`my-bookings.html`):** JS показує попередження перед скасуванням.

*   **PATCH `/admin/bookings/{booking_id}/status`**:
    *   **Роут:** `booking_router.py`, функція `update_booking_status_by_admin`.
    *   **Логіка (тільки для адмінів):** Оновлює статус бронювання (напр., з "Розглядається" на "Підтверджено"). Може оновлювати рівень довіри користувача, якщо бронювання завершено.
    *   **Фронтенд (`my-bookings.html`):** Адмін-кнопки "Підтвердити"/"Відхилити" викликають JS-функцію `updateStatus`, яка робить `PATCH` запит і оновлює UI.

*   **GET `/auth/sync`**:
    *   **Роут:** `booking_router.py`, функція `sync_guest_bookings`.
    *   **Логіка:** Використовується після того, як гість увійшов в акаунт. Прив'язує гостьові бронювання (ID яких були передані в `redirect_url`) до `user_id` щойно автентифікованого користувача.
